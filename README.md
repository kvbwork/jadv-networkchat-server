## Сетевой чат - Сервер

### Возможности

- Возможность подключиться к серверу в любой момент и присоединиться к чату.
- Выбор имени в чат-комнате с помощью команды `/login <name>`.
- Просмотр участников комнаты командой `/users`.
- Отправка сообщений всем пользователям.
- Отправка сообщения только одному пользователю с использованием команды `@<name>`.
- Обновление соединения пользователя чат-комнаты после повторного логина.
- Отключение неактивных соединений по таймауту.
- Завершение работы и разрыв соединения по команде `/exit`
- Запись всех отправленных через сервер сообщений с указанием имени пользователя и времени отправки. (`file.log`).

### Схема работы компонентов

![Схема работы](img/components.png)

### Особенности работы

Неблокирующее чтение данных пользовательских соединений позволило обойтись всего двумя дополнительными потоками.
   - `ConnectionAcceptor` для принятия новых TCP соединений.
   - `ConnectionsWorker` для обработки ввода-вывода всех соединений.
   
Была предпринята попытка обрабатывать пользовательские соединения в пуле потоков.
Но при нескольких тысячах активных пользователей происходило резкое увеличение потребления памяти.

Вариант с отдельным потоком на каждое соединение тоже не был использован. Для простого Web-сервера и короткоживущих соединений такой вариант мог бы подойти, но чат с тысячами одновременных пользователей потреблял бы слишком много ресурсов операционной системы.

Решением могли бы стать виртуальные потоки проекта Loom. Но на данный момент компоненты еще находятся в стадии preview в JDK 19.

Неблокирующие компоненты пакета Java NIO тоже рассматривались. Они не были использованы из за излишней сложности извлечения строк из буферов соединений.

При выбранной реализации чтения только доступных данных, сложно определять активность соединений. Поэтому выла введена проверка их активности и отключение по таймауту.

В текущем состоянии сервер обладает достаточным быстродействием для обработки всех пользователей одной чат-комнаты и запасом быстродействия для расширения.

### Возможности развития

- Кодировка сообщений может быть изменена. По умолчанию выбрана UTF-8.

- Легко добавить новую пользовательскую команду в `CommandHandler` т.к. он выполнен по одноименному шаблону. Список обработчиков может быть расширен, но последним в списке подразумевается `ChatHandler`.

- Безопасность. Пользователи могут указывать не только логин, но и пароль.

- С использованием SSLServerSocket может быть введено шифрование соединений.

- Чат-комнат может быть несколько. Выбор комнаты возможен на этапе логина или отдельной командой.

- Вывод истории последних публичных сообщений подключившемуся пользователю.

- При хранении сообщений появится возможность отправлять их оффлайн пользователям. Адресаты получат свои данные при следующем подключении к серверу.

### Тестирование

В проекте представлены модульные тесты отдельных компонентов и интеграционный тест с тестовым клиентом.
